<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –ü–í–ó –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</title>
    <link rel="stylesheet" href="/assets/styles/main.css">
</head>
<body>
    <div class="app">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <nav class="sidebar">
            <div class="brand">
                <div class="comment-icon">üí¨</div>
                <div>–ü–í–ó –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-toggle-icon">üåô</span>
                    <span class="theme-toggle-text">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                </button>
            </div>
            <div class="nav">
                <a href="/pvz" class="nav-item">
                    <span class="nav-icon">üì¶</span>
                    <span class="nav-text">–°–ø–∏—Å–æ–∫ –ü–í–ó</span>
                </a>
                <a href="/companies" class="nav-item">
                    <span class="nav-icon">üè¢</span>
                    <span class="nav-text">–ö–æ–º–ø–∞–Ω–∏–∏</span>
                </a>
                <a href="/roles" class="nav-item">
                    <span class="nav-icon">üîê</span>
                    <span class="nav-text">–†–æ–ª–∏</span>
                </a>
                <a href="/users" class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </a>
                <a href="/settings" class="nav-item active">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </a>
            </div>
            <div class="sidebar-bottom">
                <button id="btnLogout" class="nav-item">
                    <span class="nav-icon">üö™</span>
                    <span class="nav-text">–í—ã—Ö–æ–¥</span>
                </button>
                <div class="user-info" id="userInfo">
                    <span class="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <span class="user-role"></span>
                </div>
            </div>
        </nav>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="content">
            <div class="card">
                <div class="toolbar">
                    <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
                    <div class="spacer"></div>
                </div>
                
                <div class="settings-section">
                    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Sheets</h2>
                    <p class="section-description">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google –¢–∞–±–ª–∏—Ü–∞–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏</p>
                    
                    <form id="settingsForm" class="settings-form">
                        <div class="field">
                            <label for="pvzTableId">ID Google –¢–∞–±–ª–∏—Ü—ã –ü–í–ó</label>
                            <input type="text" id="pvzTableId" name="pvzTableId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –∏–∑ URL" required>
                            <small class="form-help">ID –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ URL —Ç–∞–±–ª–∏—Ü—ã: docs.google.com/spreadsheets/d/ID/edit</small>
                        </div>

                        <div class="field">
                            <label for="pvzSheetName">–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ü–í–ó</label>
                            <input type="text" id="pvzSheetName" name="pvzSheetName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–∏—Å—Ç1" required>
                            <small class="form-help">–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –≤ Google –¢–∞–±–ª–∏—Ü–µ, –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ü–í–ó</small>
                        </div>

                        <div class="field">
                            <label for="updateFrequency">–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</label>
                            <select id="updateFrequency" name="updateFrequency">
                                <option value="15">15 –º–∏–Ω—É—Ç</option>
                                <option value="30">30 –º–∏–Ω—É—Ç</option>
                                <option value="60" selected>1 —á–∞—Å</option>
                                <option value="120">2 —á–∞—Å–∞</option>
                                <option value="240">4 —á–∞—Å–∞</option>
                                <option value="480">8 —á–∞—Å–æ–≤</option>
                                <option value="1440">24 —á–∞—Å–∞</option>
                            </select>
                            <small class="form-help">–ö–∞–∫ —á–∞—Å—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å Google –¢–∞–±–ª–∏—Ü–µ–π</small>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="btnTestConnection" class="btn btn-secondary">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                            <button type="submit" id="btnSaveSettings" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        </div>
                    </form>
                </div>
                
                <div class="settings-section" id="syncStatusSection" class="hidden">
                    <h2>–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h2>
                    <div class="sync-status">
                        <div class="status-item">
                            <span class="status-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</span>
                            <span id="lastUpdate" class="status-value">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">–°—Ç–∞—Ç—É—Å —à–µ–¥—É–ª–µ—Ä–∞:</span>
                            <span id="schedulerStatus" class="status-value">-</span>
                        </div>
                        <div class="scheduler-controls">
                            <button class="btn btn-success" id="btnStartScheduler">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                            <button class="btn btn-warning" id="btnStopScheduler">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                            <button class="btn btn-info" id="btnForceSync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
                            <button class="btn btn-secondary" id="btnSyncLogs">–õ–æ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
                </div>
            </div>
    </div>

                <div class="settings-section">
                    <h2>–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
                    <div id="connectionStatus" class="status-indicator">
                        <div class="status-dot status-unknown"></div>
                        <span class="status-text">–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
    <script src="/modules/shared/secureApi.js"></script>
    <script src="/modules/shared/utils.js"></script>
    <script src="/modules/shared/theme.js"></script>
    <script src="/modules/shared/menu.js"></script>
    <script src="/modules/shared/navigation.js"></script>
    <script src="/modules/auth/auth.js"></script>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
            if (!secureApiClient.checkAuthAndRedirect()) {
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω—é (–≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ)
            if (window.MenuManager) {
                await window.MenuManager.initForPage();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            if (window.navigationModule) {
                await window.navigationModule.init();
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            await loadSettings();

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º—ã
            setupFormHandlers();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            await loadSyncStatus();

            console.log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
        });

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const settings = await response.json();
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('pvzTableId').value = settings.pvzTableId || '';
                    document.getElementById('pvzSheetName').value = settings.pvzSheetName || '';
                    document.getElementById('updateFrequency').value = settings.updateFrequency || '60';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (settings.pvzTableId) {
                        document.getElementById('syncStatusSection').style.display = 'block';
                    }
                    
                    console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        async function loadSyncStatus() {
            try {
                const response = await fetch('/api/data/scheduler/status', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    document.getElementById('lastUpdate').textContent = 
                        data.settings.lastUpdate ? 
                        new Date(data.settings.lastUpdate).toLocaleString() : 
                        '–ù–∏–∫–æ–≥–¥–∞';
                    
                    document.getElementById('schedulerStatus').textContent = 
                        data.status.isRunning ? '–ó–∞–ø—É—â–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    
                    console.log('‚úÖ –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω');
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        function setupFormHandlers() {
            const form = document.getElementById('settingsForm');
            const btnTestConnection = document.getElementById('btnTestConnection');
            const btnSaveSettings = document.getElementById('btnSaveSettings');
            
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
            const btnStartScheduler = document.getElementById('btnStartScheduler');
            const btnStopScheduler = document.getElementById('btnStopScheduler');
            const btnForceSync = document.getElementById('btnForceSync');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const settings = {
                    pvzTableId: formData.get('pvzTableId'),
                    pvzSheetName: formData.get('pvzSheetName'),
                    updateFrequency: formData.get('updateFrequency')
                };

                try {
                    btnSaveSettings.disabled = true;
                    btnSaveSettings.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                    } else {
                        const error = await response.json();
                        showNotification(error.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                } finally {
                    btnSaveSettings.disabled = false;
                    btnSaveSettings.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            btnTestConnection.addEventListener('click', async () => {
                const pvzTableId = document.getElementById('pvzTableId').value;
                const pvzSheetName = document.getElementById('pvzSheetName').value;

                if (!pvzTableId || !pvzSheetName) {
                    showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º', 'warning');
                    return;
                }

                try {
                    btnTestConnection.disabled = true;
                    btnTestConnection.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                    updateConnectionStatus('testing', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');

                    const response = await fetch('/api/settings/test-connection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            pvzTableId,
                            pvzSheetName
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            updateConnectionStatus('success', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                            showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                        } else {
                            updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                            showNotification(result.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                        }
                    } else {
                        updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                        showNotification('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                    updateConnectionStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                    showNotification('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                } finally {
                    btnTestConnection.disabled = false;
                    btnTestConnection.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            if (btnStartScheduler) {
                btnStartScheduler.addEventListener('click', async () => {
                    try {
                        btnStartScheduler.disabled = true;
                        btnStartScheduler.textContent = '–ó–∞–ø—É—Å–∫...';

                        const response = await fetch('/api/data/scheduler/start', {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            showNotification('–®–µ–¥—É–ª–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
                            await loadSyncStatus();
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —à–µ–¥—É–ª–µ—Ä–∞', 'error');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —à–µ–¥—É–ª–µ—Ä–∞:', error);
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —à–µ–¥—É–ª–µ—Ä–∞', 'error');
                    } finally {
                        btnStartScheduler.disabled = false;
                        btnStartScheduler.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
                    }
                });
            }

            if (btnStopScheduler) {
                btnStopScheduler.addEventListener('click', async () => {
                    try {
                        btnStopScheduler.disabled = true;
                        btnStopScheduler.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';

                        const response = await fetch('/api/data/scheduler/stop', {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            showNotification('–®–µ–¥—É–ª–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                            await loadSyncStatus();
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–µ–¥—É–ª–µ—Ä–∞', 'error');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–µ–¥—É–ª–µ—Ä–∞:', error);
                        showNotification('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–µ–¥—É–ª–µ—Ä–∞', 'error');
                    } finally {
                        btnStopScheduler.disabled = false;
                        btnStopScheduler.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                    }
                });
            }

            if (btnForceSync) {
                btnForceSync.addEventListener('click', async () => {
                    try {
                        btnForceSync.disabled = true;
                        btnForceSync.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';

                        const response = await fetch('/api/data/sync', {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showNotification(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${result.result.synced} –Ω–æ–≤—ã—Ö, ${result.result.updated} –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö`, 'success');
                            await loadSyncStatus();
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                        showNotification('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
                    } finally {
                        btnForceSync.disabled = false;
                        btnForceSync.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å';
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–õ–æ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
            const btnSyncLogs = document.getElementById('btnSyncLogs');
            if (btnSyncLogs) {
                btnSyncLogs.addEventListener('click', () => {
                    showSyncLogsModal();
                });
            }
        }

        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            const dot = statusElement.querySelector('.status-dot');
            const textElement = statusElement.querySelector('.status-text');

            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Å—Ç–∞—Ç—É—Å–∞
            dot.className = 'status-dot';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å
            switch (status) {
                case 'success':
                    dot.classList.add('status-success');
                    break;
                case 'error':
                    dot.classList.add('status-error');
                    break;
                case 'testing':
                    dot.classList.add('status-testing');
                    break;
                default:
                    dot.classList.add('status-unknown');
            }

            textElement.textContent = text;
        }

        function showNotification(message, type = 'info') {
            // –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                background: var(--accent-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'primary'});
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: var(--shadow-primary);
                transform: translateX(100%);
                opacity: 0;
                transition: all 0.3s ease;
            `;

            document.body.appendChild(notification);

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 100);

            // –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        let currentLogPage = 1;
        let currentLogFilters = {};

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function showSyncLogsModal() {
            const modal = document.getElementById('syncLogsModal');
            if (modal) {
                modal.classList.add('show');
                loadSyncLogs();
                setupLogsModalHandlers();
            }
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function hideSyncLogsModal() {
            const modal = document.getElementById('syncLogsModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–æ–≤
        function setupLogsModalHandlers() {
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const closeBtn = document.getElementById('closeSyncLogsModal');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideSyncLogsModal);
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ footer
            const closeBtnFooter = document.getElementById('closeSyncLogsModalFooter');
            if (closeBtnFooter) {
                closeBtnFooter.addEventListener('click', hideSyncLogsModal);
            }

            // –ö–ª–∏–∫ –ø–æ overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
            const modal = document.getElementById('syncLogsModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideSyncLogsModal();
                    }
                });
            }

            // –§–∏–ª—å—Ç—Ä—ã
            const statusFilter = document.getElementById('logStatusFilter');
            const typeFilter = document.getElementById('logTypeFilter');
            const refreshBtn = document.getElementById('btnRefreshLogs');

            if (statusFilter) {
                statusFilter.addEventListener('change', () => {
                    currentLogPage = 1;
                    loadSyncLogs();
                });
            }

            if (typeFilter) {
                typeFilter.addEventListener('change', () => {
                    currentLogPage = 1;
                    loadSyncLogs();
                });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    currentLogPage = 1;
                    loadSyncLogs();
                });
            }

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const prevBtn = document.getElementById('btnPrevPage');
            const nextBtn = document.getElementById('btnNextPage');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentLogPage > 1) {
                        currentLogPage--;
                        loadSyncLogs();
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    currentLogPage++;
                    loadSyncLogs();
                });
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        async function loadSyncLogs() {
            try {
                const statusFilter = document.getElementById('logStatusFilter');
                const typeFilter = document.getElementById('logTypeFilter');
                
                const params = new URLSearchParams({
                    page: currentLogPage,
                    limit: 20
                });

                if (statusFilter && statusFilter.value) {
                    params.append('status', statusFilter.value);
                }

                if (typeFilter && typeFilter.value) {
                    params.append('syncType', typeFilter.value);
                }

                const response = await fetch(`/api/settings/sync-logs?${params}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    renderSyncLogs(result.data.logs, result.data.pagination);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤', 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function renderSyncLogs(logs, pagination) {
            const tbody = document.getElementById('logsTableBody');
            if (!tbody) return;

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-muted);">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const statusClass = log.status === 'success' ? 'success' : 
                                  log.status === 'error' ? 'error' : 'warning';
                const statusText = log.status === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : 
                                 log.status === 'error' ? '–û—à–∏–±–∫–∞' : '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ';
                
                const date = new Date(log.created_at).toLocaleString('ru-RU');
                
                return `
                    <tr>
                        <td>${date}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${log.sync_type}</td>
                        <td title="${log.details || ''}">${log.message}</td>
                        <td>${log.records_processed || 0}</td>
                        <td>${log.records_created || 0}</td>
                        <td>${log.records_updated || 0}</td>
                        <td>${log.records_skipped || 0}</td>
                        <td>${log.execution_time_ms || 0}</td>
                    </tr>
                `;
            }).join('');

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            updateLogsPagination(pagination);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
        function updateLogsPagination(pagination) {
            const prevBtn = document.getElementById('btnPrevPage');
            const nextBtn = document.getElementById('btnNextPage');
            const info = document.getElementById('paginationInfo');

            if (prevBtn) {
                prevBtn.disabled = pagination.page <= 1;
            }

            if (nextBtn) {
                nextBtn.disabled = pagination.page >= pagination.pages;
            }

            if (info) {
                info.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.page} –∏–∑ ${pagination.pages}`;
            }
        }
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div class="overlay" id="syncLogsModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">–õ–æ–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Google Sheets</h3>
                <button class="close" id="closeSyncLogsModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="log-filters">
                    <div class="filter-group">
                        <label for="logStatusFilter">–°—Ç–∞—Ç—É—Å:</label>
                        <select id="logStatusFilter">
                            <option value="">–í—Å–µ</option>
                            <option value="success">–£—Å–ø–µ—à–Ω–æ</option>
                            <option value="error">–û—à–∏–±–∫–∞</option>
                            <option value="warning">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="logTypeFilter">–¢–∏–ø:</label>
                        <select id="logTypeFilter">
                            <option value="">–í—Å–µ</option>
                            <option value="pvz">–ü–í–ó</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="btnRefreshLogs">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ -->
                <div class="logs-table-container">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¢–∏–ø</th>
                                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                                <th>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</th>
                                <th>–°–æ–∑–¥–∞–Ω–æ</th>
                                <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                                <th>–ü—Ä–æ–ø—É—â–µ–Ω–æ</th>
                                <th>–í—Ä–µ–º—è (–º—Å)</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; color: var(--text-muted);">
                                    –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                <div class="logs-pagination">
                    <button class="btn btn-sm" id="btnPrevPage" disabled>‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                    <span id="paginationInfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
                    <button class="btn btn-sm" id="btnNextPage" disabled>–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeSyncLogsModalFooter">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

</body>
</html>
