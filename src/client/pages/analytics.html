<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –ü–í–ó –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</title>
    <link rel="stylesheet" href="/assets/styles/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <nav class="sidebar">
            <div class="brand">
                <div class="comment-icon">üí¨</div>
                <div>–ü–í–ó –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                <button class="theme-toggle" id="themeToggle">
                    <span class="theme-toggle-icon">üåô</span>
                    <span class="theme-toggle-text">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                </button>
            </div>
            <div class="nav">
                <a href="/pvz" class="nav-item">
                    <span class="nav-icon">üì¶</span>
                    <span class="nav-text">–°–ø–∏—Å–æ–∫ –ü–í–ó</span>
                </a>
                <a href="/analytics" class="nav-item active">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
                </a>
                <a href="/companies" class="nav-item">
                    <span class="nav-icon">üè¢</span>
                    <span class="nav-text">–ö–æ–º–ø–∞–Ω–∏–∏</span>
                </a>
                <a href="/roles" class="nav-item">
                    <span class="nav-icon">üîê</span>
                    <span class="nav-text">–†–æ–ª–∏</span>
                </a>
                <a href="/users" class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span class="nav-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </a>
            </div>
            <div class="sidebar-bottom">
                <button id="btnLogout" class="nav-item">
                    <span class="nav-icon">üö™</span>
                    <span class="nav-text">–í—ã—Ö–æ–¥</span>
                </button>
                <div class="user-info" id="userInfo">
                    <span class="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <span class="user-role"></span>
                </div>
            </div>
        </nav>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="content">
            <div class="page-header">
                <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ü–í–ó</h2>
                <div class="page-actions">
                    <button class="btn btn-primary" id="btnRefresh">
                        <span>üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
            <div class="analytics-filters">
                <div class="filter-group">
                    <label for="dateFrom">–û—Ç:</label>
                    <input type="date" id="dateFrom" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="dateTo">–î–æ:</label>
                    <input type="date" id="dateTo" class="form-control">
                </div>
                <div class="filter-group">
                    <label for="regionFilter">–†–µ–≥–∏–æ–Ω:</label>
                    <select id="regionFilter" class="form-control">
                        <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="companyFilter">–ö–æ–º–ø–∞–Ω–∏—è:</label>
                    <select id="companyFilter" class="form-control">
                        <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <button class="btn btn-secondary" id="btnApplyFilters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ -->
            <div class="metrics-cards">
                <div class="metric-card">
                    <div class="metric-icon">üì¶</div>
                    <div class="metric-content">
                        <div class="metric-value" id="totalPvz">0</div>
                        <div class="metric-label">–í—Å–µ–≥–æ –ü–í–ó</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-content">
                        <div class="metric-value" id="problematicPvz">0</div>
                        <div class="metric-label">–° –ø—Ä–æ–±–ª–µ–º–∞–º–∏</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚úÖ</div>
                    <div class="metric-content">
                        <div class="metric-value" id="problemFreePvz">0</div>
                        <div class="metric-label">–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-content">
                        <div class="metric-value" id="problemPercentage">0%</div>
                        <div class="metric-label">% –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="charts-container">
                <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üìà –ó–∞—è–≤–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-secondary" id="exportStatusChart">–≠–∫—Å–ø–æ—Ä—Ç</button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <div class="chart-content">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-legend" id="statusLegend"></div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –ø–æ —Ç–∏–ø–∞–º</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-secondary" id="exportProblemsChart">–≠–∫—Å–ø–æ—Ä—Ç</button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <div class="chart-content">
                            <canvas id="problemsChart"></canvas>
                        </div>
                        <div class="chart-legend" id="problemsLegend"></div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üó∫Ô∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-secondary" id="exportRegionsChart">–≠–∫—Å–ø–æ—Ä—Ç</button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <div class="chart-content">
                            <canvas id="regionsChart"></canvas>
                        </div>
                        <div class="chart-legend" id="regionsLegend"></div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>üè¢ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-secondary" id="exportCompaniesChart">–≠–∫—Å–ø–æ—Ä—Ç</button>
                        </div>
                    </div>
                    <div class="chart-body">
                        <div class="chart-content">
                            <canvas id="companiesChart"></canvas>
                        </div>
                        <div class="chart-legend" id="companiesLegend"></div>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü—ã —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
            <div class="tables-container">

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º -->
                <div class="table-card">
                    <div class="table-header">
                        <h3>üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º</h3>
                    </div>
                    <div class="table-content">
                        <table class="analytics-table" id="problemsStatsTable">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                                    <th>–¶–≤–µ—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
    <script src="/modules/shared/theme.js"></script>
    <script src="/modules/shared/secureApi.js"></script>
    <script src="/modules/shared/utils.js"></script>
    <script src="/modules/shared/menu.js"></script>
    <script src="/modules/analytics/analytics.js"></script>
    
    <script>
        let pageInitialized = false;
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (pageInitialized) {
                console.log('üìä –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                return;
            }
            
            console.log('üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                if (!window.secureApiClient || !window.secureApiClient.checkAuthAndRedirect()) {
                    console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω');
                    return;
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω—é –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (window.MenuManager) {
                    await window.MenuManager.initForPage();
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                if (window.analyticsModule) {
                    await window.analyticsModule.init();
                }
                
                pageInitialized = true;
                console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
            }
        });
    </script>
</body>
</html>
