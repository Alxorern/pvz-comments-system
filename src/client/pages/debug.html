<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - –ü–í–ó –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</title>
    <link rel="stylesheet" href="../assets/styles/main.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand">
                <div class="comment-icon">üí¨</div>
                <h1>–ü–í–ó –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ - Debug</h1>
            </div>
        </div>

        <div class="content">
            <div class="card">
                <h2>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
                
                <div class="form-group">
                    <button id="testDb" class="btn btn-primary">–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î</button>
                    <button id="testUsers" class="btn btn-secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                    <button id="testRoles" class="btn btn-secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª–∏</button>
                    <button id="testJoin" class="btn btn-secondary">–¢–µ—Å—Ç JOIN –∑–∞–ø—Ä–æ—Å–∞</button>
                </div>

                <div id="results" class="debug-results">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
                    <pre id="output"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function clearLog() {
            output.textContent = '';
        }

        async function testDb() {
            clearLog();
            log('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...');
            
            try {
                const response = await fetch('/api/debug/db-info');
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                    log(`üìÅ –§–∞–π–ª –ë–î: ${data.filename}`);
                    log(`üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${data.fileSize} –±–∞–π—Ç`);
                    log(`üìã –¢–∞–±–ª–∏—Ü—ã: ${data.tables.join(', ')}`);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            }
        }

        async function testUsers() {
            log('\nüë• –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
            
            try {
                const response = await fetch('/api/debug/users');
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.users.length}`);
                    data.users.forEach(user => {
                        log(`  - ID: ${user.user_id}, Login: ${user.login}, Role ID: ${user.role_id}`);
                    });
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            }
        }

        async function testRoles() {
            log('\nüé≠ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏...');
            
            try {
                const response = await fetch('/api/debug/roles');
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ä–æ–ª–µ–π: ${data.roles.length}`);
                    data.roles.forEach(role => {
                        log(`  - ID: ${role.id}, Name: ${role.name}, Active: ${role.is_active}`);
                    });
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            }
        }

        async function testJoin() {
            log('\nüîó –¢–µ—Å—Ç–∏—Ä—É–µ–º JOIN –∑–∞–ø—Ä–æ—Å...');
            
            try {
                const response = await fetch('/api/debug/join-test');
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ JOIN —Ä–µ–∑—É–ª—å—Ç–∞—Ç:`);
                    data.results.forEach(result => {
                        log(`  - User ID: ${result.user_id}, Login: ${result.login}, Role: ${result.role_name}, Active: ${result.is_active}`);
                    });
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('testDb').addEventListener('click', testDb);
        document.getElementById('testUsers').addEventListener('click', testUsers);
        document.getElementById('testRoles').addEventListener('click', testRoles);
        document.getElementById('testJoin').addEventListener('click', testJoin);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...');
            testDb();
        });
    </script>
</body>
</html>
